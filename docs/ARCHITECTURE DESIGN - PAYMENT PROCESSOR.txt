================================================================================
ARCHITECTURE DESIGN: MULTI-CURRENCY PAYMENT SYSTEM (CLEAN ARCHITECTURE)
================================================================================

ccy-payment-processor/
├── .gitignore
├── LICENSE
├── README.md                  # Project documentation
├── docker-compose.yml         # Infrastructure Orchestration
├── Dockerfile                 # Container Recipe
├── go.mod                     # Dependency Management
├── docs/                      # Arch docs and sequence flows
│   ├── ARCHITECTURE DESIGN - PAYMENT PROCESSOR.txt
│   └── PAYMENT PROCESSOR SYSTEM SEQUENCE FLOW.jpg
└── src/                       # THE SOURCE ROOT
    ├── cmd/
    │   └── server/
    │       └── main.go        # Entry point: Wires up the App
    ├── internal/
    │   ├── adapter/           # EXTERNAL INTERFACES
    │   │   ├── http/          # Handlers & Middleware
    │   │   └── repository/    # Postgres & SQL Logic
    │   ├── config/            # AppSettings loader
    │   ├── domain/            # CORE ENTITIES (Entities & Interfaces)
    │   └── usecase/           # BUSINESS LOGIC (The Brain)
    ├── migrations/            # SQL scripts for DB evolution
    └── appsettings.json       # Config (Charges, VAT, Channel Creds)


1. AUTHENTICATION & SECURITY
----------------------------
* Channel Validation: 
    - Incoming requests checked against 'appsettings' (ChannelCredentials).
    - Logic: IF (Request.SourceCredentials == AppSettings.Credentials) ALLOW ELSE DENY.
* Transaction Authorization:
    - TransactionPin required for every transfer request.

2. SYSTEM ENTITIES (CORE MODELS)
--------------------------------
* Users: Auth and Profile data including customer Id.
* Accounts: CustomerId, Account related data and available amount, account status, etc
* Transfers: Main transaction log (ID, Status, PaymentRef, AuditPayload).
* Rates: CCY record - FromCcy, ToCcy, Rate, RateDate.
* TransientAccountTransactions: Ledger for the Suspense Account movements.

3. API ENDPOINTS
----------------
* POST /getAccount          -> { accountnumber }
* GET  /getparticipantbanks -> returns List<Bank>
* POST /validateaccount     -> { accountnumber, bankcode }
* POST /convertfcyamount    -> { amount, fromCcy, toCcy }
* GET  /getcharges          -> ?ccy=USD&amount=100
* POST /intratransfer       -> (Internal Transfer Payload)
* POST /intertransfers      -> (External Transfer Payload + bankcode)

4. TRANSFER BUSINESS LOGIC (USE CASE)
-------------------------------------
A. Pre-Processing:
   - Validate ChannelCode & TransactionPin.
   - Validate Debit Account & Beneficiary (Account number/Bank code).
   - Check Available Balance >= (Amount + Charges + VAT).
     * Charges: Static (from AppSettings).
     * VAT: 7.5% of Amount (in Sender's CCY).

B. Persistence (State Management):
   - Create Transfer record (Status: PENDING).
   - Store full Request Body as a Serialized String in 'audit_payload' column.

C. Fund Movement (Suspense Account Pattern):
   - IF (DebitCCY == CreditCCY):
     1. Debit Sender (Amount + Charges + VAT).
     2. Credit Suspense Account (Amount).
     3. Credit Beneficiary from Suspense Account.

   - IF (DebitCCY != CreditCCY):
     IF (isAmountInBeneficiaryCurrency == true):
       1. Convert Target Amount -> Sender CCY.
       2. Debit Sender (ConvertedAmount equivalence in their own account ccy + Charges + VAT).
       3. Credit Beneficiary exact Target Amount via Suspense.
     ELSE (isAmountInBeneficiaryCurrency == false):
       1. Debit Sender (Amount + Charges + VAT).
       2. Convert Amount -> Beneficiary CCY (convertedAmount).
       3. Credit Beneficiary 'convertedAmount' via Suspense.

D. Post-Processing:
   - Generate unique PaymentReference.
   - Update 'Transfers' table status to SUCCESS.
   - Update 'TransientAccountTransactions' with the PaymentReference.

5. CLEAN ARCHITECTURE STRUCTURE
-------------------------------
/internal
  /domain       <- Entities (User, Transfer, Account) + Logic Interfaces
  /usecase      <- TransferService (The logic above lives here)
  /adapter
    /http       <- API Handlers (Gin/Fiber) + Channel Auth Middleware
    /repository <- Postgres Implementation (SQL Transactions)
    /config     <- AppSettings/Environment Loader
================================================================================
